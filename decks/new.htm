<html>
<head>
<meta charset="utf-8" />
<title>mycard</title>
<script src="http://code.jquery.com/jquery-1.8.2.min.js"></script>
<script>
	function parse(fileinput){
		var file = fileinput.files[0]
		var result = './?name=' + encodeURIComponent(file.name) + '&cards='
		if(file){
			var reader = new FileReader()
			reader.readAsText(file)
			reader.onload = function(evt){
				var lines = evt.target.result.split("\n")
				var side = false
				var last_id = 0
				var count = 0
				for(var i in lines){
					var line = lines[i]
					if(line.charAt(0) == '#'){
						continue
					}else if(line.substr(0,5) == '!side'){
						if(last_id){
							result += encode(last_id | (side << 29) | (count << 27))
						}
						side = true
					}else{
						var id = parseInt(line)
						if(id){ //!=0
							if(id == last_id){
								count++
							}else{
								if(last_id){
									result += encode(last_id | (side << 29) | (count << 27))
								}
								last_id = id
								count = 1
							}
						}
					}
				}
				location.href = result
			}
		}
	}
	function encode(number){
		var key = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789*-="
		var result = ''
		for(i=0;i<5;i++){
			result = key.charAt(number & 0x3F) + result
			number >>= 6
		}
		return result
	}
	  function decode(str){
	var key = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789*-="
	var result = 0
	for(var i in str){
		result <<= 6
		result += key.indexOf(str.charAt(i))
	}
	return result
  }
</script>
</head>
<body>
<form>
	<input type="file" onchange="parse(this);"/>
</form>

</body>
</html>
